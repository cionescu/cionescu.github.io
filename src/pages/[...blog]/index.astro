---
import type { InferGetStaticPropsType, GetStaticPaths } from 'astro';

import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import TableOfContents from '~/components/blog/TableOfContents.astro';

import { getCanonical, getPermalink } from '~/utils/permalinks';
import { fetchPosts, getStaticPathsBlogPost, blogPostRobots } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData } from '~/types';
import { getBlogPermalink } from '~/utils/permalinks';

export const prerender = true;

export const getStaticPaths = (async () => {
  return await getStaticPathsBlogPost();
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.props as Props;

const url = getCanonical(getPermalink(post.permalink, 'post'));
const image = (await findImage(post.image)) as ImageMetadata | string | undefined;

const fetchedPosts = await fetchPosts();
const latestArticles = fetchedPosts
  .filter((p) => p.slug !== post.slug)
  .sort((a, b) => Number(new Date(b.publishDate)) - Number(new Date(a.publishDate)))
  .slice(0, 3);

const sectionConfig = post.permalink?.startsWith('today-i-learned')
  ? { label: 'Today I Learned', href: '/today-i-learned' }
  : post.permalink?.startsWith('ai-agent')
    ? { label: 'Building AI Agents', href: '/ai-agent' }
    : { label: 'Guides', href: getBlogPermalink() };
const sectionLabel = sectionConfig.label;
const sectionHref = sectionConfig.href;

const metadata = merge(
  {
    title: post.title,
    description: post.excerpt,
    robots: {
      index: blogPostRobots?.index,
      follow: blogPostRobots?.follow,
    },
    openGraph: {
      type: 'article',
      ...(image
        ? { images: [{ url: image, width: (image as ImageMetadata)?.width, height: (image as ImageMetadata)?.height }] }
        : {}),
    },
  },
  { ...(post?.metadata ? { ...post.metadata, canonical: post.metadata?.canonical || url } : {}) }
) as MetaData;
---

  <Layout metadata={metadata}>
    <div class="bg-vadim-bg min-h-screen">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="flex items-center text-sm text-gray-500 mb-8">
          <a href="/" class="hover:text-accent-orange">Home</a>
          <span class="mx-2">/</span>
          <a href={sectionHref} class="hover:text-accent-orange">{sectionLabel}</a>
          <span class="mx-2">/</span>
          <span class="text-gray-900">{post.title}</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-12">
          <article class="min-w-0">
            <SinglePost post={{ ...post, image: image }} url={url} />
          </article>

          <aside class="hidden lg:block">
            <div class="sticky top-24 space-y-12">
              <TableOfContents />

              <div>
                <h4 class="font-bold text-gray-900 mb-4 text-sm uppercase tracking-wider">Latest articles</h4>
                <div class="space-y-1">
                  {
                    latestArticles.map((p) => (
                      <a href={getPermalink(p.permalink, 'post')} class="flex items-start gap-3 group py-2">
                        <span class="text-lg mt-0.5 flex-shrink-0">{p.emoji || '‚≠ê'}</span>
                        <span class="text-sm text-gray-600 font-medium group-hover:text-accent-orange group-hover:underline decoration-accent-orange/30 underline-offset-4 transition-all leading-snug">
                          {p.title}
                        </span>
                      </a>
                    ))
                  }
                </div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </Layout>
